<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Example</title>
  </head>
  <body>
    <h1>WebSocket Example</h1>

    <!-- <script src="websocket-example.js"></script> -->

    <script>
      // WebSocket connection URL
      const socketUrl = "ws://localhost:9002";

      let sizeSum = 0;
      let lastTs = Date.now();
      let cnt = 0;

      function createOneWebsocket(socketName) {
        const socket = new WebSocket(socketUrl);
        socket.addEventListener("open", (event) => {
          console.log("CONNECTED", event);
          socket.send("WEB MESSAGE!!");
        });

        socket.addEventListener("message", (event) => {
          const message = event.data;
          displayMessage(message);
        });

        // Event listener for when an error occurs
        socket.addEventListener("error", (event) => {
          console.error("WebSocket error:", event);
        });

        // Event listener for when the WebSocket connection is closed
        socket.addEventListener("close", (event) => {
          console.log("WebSocket connection closed:", event);
        });

        function blobToDataView(blob) {
          return new Promise((resolve, reject) => {
            const fileReader = new FileReader();

            fileReader.onload = function (event) {
              const arrayBuffer = event.target.result;
              const dataView = new DataView(arrayBuffer);
              resolve(dataView);
            };

            fileReader.onerror = function (event) {
              reject(event.target.error);
            };

            fileReader.readAsArrayBuffer(blob);
          });
        }

        // Function to display a message in the UI
        function displayMessage(data) {
          console.log('displayMessage: ', data);
          const now = Date.now();
          const MB = 1 * 1024 * 1024;
          const size = data.size / MB;
          const bt = data.slice(0, 8);
          blobToDataView(bt).then((view) => {
            // 使用DataView读取64位有符号整数
            const bigInt = view.getBigInt64(0, true);
            const sendTs = Number(bigInt.toString());
            const diff = now - sendTs;
            console.log(`speed:`, cnt, diff, (size / diff) * 1000);
            cnt++;
            sizeSum += size;
          });
          cnt;
        }
      }

      setInterval(() => {
        const now = Date.now();
        const bw = (sizeSum / (now - lastTs)) * 1000;
        lastTs = now;
        sizeSum = 0;
        console.log(`bandwidth `, bw);
      }, 1000);

      createOneWebsocket("socket1");
    </script>
  </body>
</html>
